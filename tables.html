<!DOCTYPE html>
<html>
  <head>
    <script src="http://d3js.org/d3.v2.min.js"></script>
    <script src="d3.sheet.js"></script>
    <style type="text/css">

      body {
        font-family: "Helvetica Neue", Helvetica, sans-serif;
        font-size: 14px;
        line-height: 1.2em;
        padding: 20px;
      }

      #container {
        width: 40em;
        margin: 0 auto;
      }

      table.data {
        border-spacing: 0;
        margin: 0 0 1em 0;
      }

        table.data caption {
          font-weight: bold;
        }

      table.data th,
      table.data td {
        text-align: right;
        vertical-align: bottom;
        padding: 4px;
      }

      table.data th:first-child,
      table.data td:first-child {
        text-align: right;
        vertical-align: bottom;
        padding: 4px;
      }

      table.data th {
        width: 10%;
      }

      table.data tbody td {
        font-family: "Monaco", "Courier New", monospace;
        font-size: 12px;
        vertical-align: top;
      }

    </style>
  </head>
  <body>

    <div id="container">

      <table id="exhibit01" class="data"
        data-url="data/2012/01-firearms-manufactured_1986-2012.csv">
        <caption>
          Exhibit 1. Firearms Manufactured (1986-2010)
        </caption>
        <thead>
          <tr>
            <th class="sortable" data-key="Calendar Year">Year</th>
            <th class="colored sortable" data-group="type">Pistols</th>
            <th class="colored sortable" data-group="type">Revolvers</th>
            <th class="colored sortable" data-group="type">Rifles</th>
            <th class="colored sortable" data-group="type">Shotguns</th>
            <th class="colored sortable" data-group="type">Misc. Firearms</th>
            <th class="colored sortable">Total Firearms</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit02" class="data"
        data-url="data/2012/02-firearms-maunfacturer-exports_1986-2010.csv">
        <caption>
          Exhibit 2. Firearms Manufacturers&rsquo; Exports (1986 - 2010)
        </caption>
        <thead>
          <tr>
            <th class="sortable" data-key="Calendar Year">Year</th>
            <th class="colored sortable" data-group="type">Pistols</th>
            <th class="colored sortable" data-group="type">Revolvers</th>
            <th class="colored sortable" data-group="type">Rifles</th>
            <th class="colored sortable" data-group="type">Shotguns</th>
            <th class="colored sortable" data-group="type">Misc. Firearms</th>
            <th class="colored sortable">Total Firearms</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit03" class="data"
        data-url="data/2012/03-firearms-imports_1986-2011.csv">
        <caption>
          Exhibit 3. Firearms Imports (1986 - 2011)
        </caption>
        <thead>
          <tr>
            <th class="sortable">Year</th>
            <th class="colored sortable" data-group="type">Shotguns</th>
            <th class="colored sortable" data-group="type">Rifles</th>
            <th class="colored sortable" data-group="type">Handguns</th>
            <th class="colored sortable">Total</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit04" class="data"
        data-url="data/2012/04-importation-applications_1986-2011.csv">
        <caption>
          Exhibit 4. Importation Applications (1986 - 2011)
        </caption>
        <thead>
          <tr>
            <th class="sortable">Year</th>
            <th class="colored sortable" data-group="type">Licensed Importer</th>
            <th class="colored sortable" data-group="type">Military</th>
            <th class="colored sortable" data-group="type">Other</th>
            <th class="colored sortable">Total</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit05" class="data"
        data-url="data/2012/05-firearms-imported-into-us-by-country_2011.csv">
        <caption>
          Exhibit 5. Firearms Imported into the United States by Country 2011
        </caption>
        <thead>
          <tr>
            <th class="sortable">Country</th>
            <th class="colored sortable" data-group="type">Handguns</th>
            <th class="colored sortable" data-group="type">Rifles</th>
            <th class="colored sortable" data-group="type">Shotguns</th>
            <th class="colored sortable">Total Firearms</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit06" class="data"
        data-url="data/2012/06-nfa-tax-revenues-activites_1979-2011.csv">
        <caption>
          Exhibit 6. National Firearms Act Tax Revenues and Related Activities (1979 - 2011)
        </caption>
        <thead>
          <tr class="categories">
            <td colspan="3"></td>
            <th colspan="2">Enforcement Support</th>
          </tr>
          <tr>
            <th class="sortable" data-key="Fiscal Year">Year</th>
            <th class="colored sortable" data-type="money" data-key="Occupational Tax Paid">O. Tax Paid</th>
            <th class="colored sortable" data-type="money" data-key="Transfer and Making Tax Paid">T&amp;M Tax Paid</th>
            <th class="colored sortable" data-key="Enforcement Support Certifications">Certifications</th>
            <th class="colored sortable" data-key="Enforcement Support Records Checks">Records Checks</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit07" class="data"
        data-url="data/2012/07-nfa-firearms-processed-by-type_1990-2011.csv">
        <caption>
          Exhibit 7. National Firearms Act Firearms Processed by Form Type (1990 - 2011)
        </caption>
        <thead>
          <tr>
            <th class="sortable" data-key="Calendar Year">Year</th>
            <th class="colored sortable">Application to Make NFA Firearms</th>
            <th class="colored sortable">Manufactured and Imported</th>
            <th class="colored sortable" data-group="applications">Application for Tax Exempt Transfer Between Licensees</th>
            <th class="colored sortable" data-group="applications">Application for Taxpaid Transfer</th>
            <th class="colored sortable" data-group="applications">Application for Tax-Exempt Transfer</th>
            <th class="colored sortable">Exported</th>
            <th class="colored sortable">Total Firearms Processed</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit08" class="data"
        data-url="data/2012/08-nfa-registered-weapons-by-state_2012-03.csv">
        <caption>
          Exhibit 8. National Firearms Act Registered Weapons by State (March 2012)
        </caption>
        <thead>
          <tr>
            <th class="sortable">State</th>
            <th class="colored sortable">Any Other Weapon</th>
            <th class="colored sortable">Destructive Device</th>
            <th class="colored sortable" data-group="type">Machinegun</th>
            <th class="colored sortable" data-group="type">Silencer</th>
            <th class="colored sortable" data-group="type">Short Barreled Rifle</th>
            <th class="colored sortable" data-group="type">Short Barreled Shotgun</th>
            <th class="colored sortable">Total</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit09" class="data"
        data-url="data/2012/09-nfa-special-occupational-taxpayers-by-state_2011.csv">
        <caption>
          Exhibit 9. National Firearms Act Special Occupational Taxpayers<br>by State - Tax Year 2011
        </caption>
        <thead>
          <tr>
            <th class="sortable">State</th>
            <th class="colored sortable">Importers</th>
            <th class="colored sortable">Manufacturers</th>
            <th class="colored sortable">Dealers</th>
            <th class="colored sortable">Total</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit10" class="data"
        data-url="data/2012/10-federal-firearms-licensees-total_1975-2011.csv">
        <caption>
          Exhibit 10. Federal Firearms Licensees Total (1975-2011)
        </caption>
        <thead>
          <tr class="categories">
            <td colspan="4"></td>
            <th colspan="2">Manufacturer of</th>
            <td colspan="1"></td>
            <th colspan="2">Destructive Device</th>
            <td colspan="1"></td>
          </tr>
          <tr>
            <th class="sortable" data-key="Fiscal Year">Year</th>
            <th class="colored sortable">Dealer</th>
            <th class="colored sortable">Pawn-broker</th>
            <th class="colored sortable">Collector</th>
            <th class="colored sortable" data-key="Ammunition Manufacturer">Ammunition</th>
            <th class="colored sortable" data-key="Firearms Manufacturer">Firearms</th>
            <th class="colored sortable">Importer</th>
            <th class="colored sortable" data-key="Device Dealer">Dealer</th>
            <th class="colored sortable" data-key="Device Manufacturer">Manufacturer</th>
            <th class="colored sortable" data-key="Device Importer">Importer</th>
            <th class="colored sortable">Total</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit11" class="data"
        data-url="data/2012/11-federal-firearms-licensees-by-state_2011.csv">
        <caption>
          Exhibit 11. Federal Firearms Licensees by State 2011
        </caption>
        <thead>
          <tr>
            <th class="sortable">State</th>
            <th class="colored sortable">FFL Population</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit12" class="data"
        data-url="data/2012/12-actions-on-federal-firearms-license-applications_1975-2011.csv">
        <caption>
          Exhibit 12. Actions on Federal Firearms License Applications (1975 - 2011)
        </caption>
        <thead>
          <tr class="categories">
            <td colspan="1"></td>
            <th colspan="4">Original Application</th>
          </tr>
          <tr>
            <th class="sortable" data-key="Fiscal Year">Year</th>
            <th class="colored sortable">Processed</th>
            <th class="colored sortable">Denied</th>
            <th class="colored sortable">Withdrawn</th>
            <th class="colored sortable">Abandoned</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <table id="exhibit13" class="data"
        data-url="data/2012/13-federal-firearms-licenses-and-compliance-inspections_1969-2011.csv">
        <caption>
          Exhibit 13. Federal Firearms Licensees and Compliance Inspections (FY 1969 - FY 2011)
        </caption>
        <thead>
          <tr>
            <th class="sortable" data-key="Fiscal Year">Year</th>
            <th class="colored sortable">Licensees</th>
            <th class="colored sortable">Inspections</th>
            <th class="colored sortable">Percent Inspected</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

    </div>

    <script>

      var parsers = d3.sheet.parse;

      d3.selectAll("table[data-url]")
        .datum(function() {
          return this.dataset;
        })
        .each(function(d, i) {
          var load = d.url.substr(-3) === "tsv" ? d3.tsv : d3.csv,
              table = this;
          load(d.url, function(rows) {
            populate(table, rows);
          });
        });

      function populate(node, rows) {
        var table = d3.select(node),
            thead = table.select("thead"),
            headers = thead.selectAll("tr:last-child > th")
              .datum(function(d, i) {
                return {
                  index: i,
                  key: this.dataset.key || this.textContent,
                  colored: this.classList.contains("colored"),
                  group: this.dataset.group,
                  type: this.dataset.type || "number",
                  sortable: this.classList.contains("sortable")
                };
              }),
              unpack = d3.sheet.unpack();

          var columns = [];
          headers.each(function(col) {
            if (col.type) {
              unpack.column(col.key, parsers[col.type]);
            }
            columns.push(col);
          });

          var unpacked = rows.map(unpack),
              colors = ["#fff", "#f00"],
              groups = {};
          columns.forEach(function(col) {

            var values = unpacked.map(function(row) {
                  return (typeof row[col.key] === "object")
                    ? row[col.key].value
                    : NaN;
                })
                  .filter(function(n) { return !isNaN(n); })
                  .sort(),
                extent = d3.extent(values);

            col.scale = d3.scale.linear()
              .domain(extent)
              .range(colors);

              if (col.group) {
                if (col.group in groups) {
                  groups[col.group].push(col);
                } else {
                  groups[col.group] = [col];
                }
              }
          });

          /*
          for (var key in groups) {
            var group = groups[key],
                domain = group[0].scale.domain(),
                len = group.length;
            for (var i = 1; i < len; i++) {
              var d = group[i].scale.domain();
              if (d[0] < domain[0]) domain[0] = d[0];
              if (d[1] > domain[1]) domain[1] = d[1];
            }
            var scale = d3.scale.linear()
              .domain(domain)
              .range(["#fff", "#f0f"]);
            group.forEach(function(col) {
              col.scale = scale;
            });
          }
          */

          tbody = table.selectAll("tbody")
            .data([unpacked]);
          tbody.enter().append("tbody");

          var rows = tbody.selectAll("tr")
            .data(function(d) { return d; })
            .enter()
            .append("tr");

          var cells = rows.selectAll("td")
            .data(function(row) {
              return row.cells = columns.map(function(col, i) {
                var cell = row[col.key] || {value: "-"};
                cell.column = columns[i];
                return cell;
              });
            })
            .enter()
            .append("td")
              .text(function(d) {
                return d.string;
              })
              .attr("data-value", function(d) {
                return d.value;
              });

          cells.filter(function(d) {
            return d.column.colored;
          })
          .style("background-color", function(d) {
            return d.column.scale(d.value);
          });

          var sortedCol = null,
              sortLinks = headers.each(function(d) {
                d.text = this.textContent;
              })
              .text("")
              .append("a")
                .text(function(d) {
                  return d.text;
                })
                .attr("class", "unsorted")
                .on("click", function(col) {
                  var getter = function(row) {
                        return row[col.key].value;
                      },
                      order = col.order === d3.descending
                        ? d3.ascending
                        : d3.descending;

                  rows.sort(function(a, b) {
                    return order(getter(a), getter(b));
                  });

                  col.order = order;

                  sortLinks
                    .attr("class", function(d) {
                      return d === col
                        ? ["sorted", "sorted-" + (col.order === d3.ascending ? "asc" : "desc")].join(" ")
                        : "unsorted";
                    });
                });
      }

      function dataset() {
        return this.dataset;
      }

    </script>
  </body>
</html>
